# 9. –°–±–æ—Ä–∫–∞ Docker-–æ–±—Ä–∞–∑–æ–≤ –ø–æ JSON-–∫–æ–Ω—Ñ–∏–≥—É (`build_docker.py`)

–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ–ø–∏—Å—ã–≤–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã Docker-—Å–±–æ—Ä–∫–∏ –≤ –¥–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω–æ–º JSON-—Ñ–∞–π–ª–µ –∏ –∑–∞–ø—É—Å–∫–∞—Ç—å **–æ–¥–Ω—É –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ** —Å–±–æ—Ä–æ–∫ –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π.

> **–ó–∞—á–µ–º?**
> ‚Ä¢ –ò–∑–±–∞–≤–∏—Ç—å—Å—è –æ—Ç –≥—Ä–æ–º–æ–∑–¥–∫–∏—Ö `bash`-—Å—Ç—Ä–æ–∫ –≤ CI.
> ‚Ä¢ –•—Ä–∞–Ω–∏—Ç—å —Ä–∞–∑–Ω—ã–µ –ø—Ä–µ—Å–µ—Ç—ã (dev, prod, CUDA-–≤–µ—Ä—Å–∏–∏) –≤ VCS.
> ‚Ä¢ –õ–µ–≥–∫–æ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∏ –∫–µ—à-—Å–ª–æ–∏.

---
## 1. –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

1. –û–ø–∏—à–∏—Ç–µ —Å–±–æ—Ä–∫—É –≤ `docker/build_config.json`:
   ```jsonc
   {
     "defaults": {
       "dockerfile": "docker/Dockerfile-uv",   // –ø—É—Ç—å –∫ Dockerfile
       "context": "."                          // –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å–±–æ—Ä–∫–∏
     },
     "builds": [
       {
         "tag": "myproject:prod-cu124",        // –∏—Ç–æ–≥–æ–≤—ã–π —Ç–µ–≥
         "mode": "prod",                       // —Ä–µ–∂–∏–º (dev|prod)
         "base_image": "nvidia/cuda:12.4.1-cudnn-devel-ubuntu22.04", // –±–∞–∑–æ–≤—ã–π FROM
         "uv_version": "0.7.18",               // –≤–µ—Ä—Å–∏—è uv
         "cmake_version": "3.29.2",            // –≤–µ—Ä—Å–∏—è CMake
         "toml_path": "prod/pyproject.toml",   // pyproject –¥–ª—è prod
         "lock_path": "py310_cu124.lock",      // —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π lock-—Ñ–∞–π–ª
         "torch_index": "https://download.pytorch.org/whl/cu124", // —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π PyTorch wheels
         "platforms": "linux/amd64",           // multi-arch (–æ–ø—Ü.)
         "load": true                           // –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π –¥–æ–∫–µ—Ä
       }
     ]
   }
   ```

2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç:
   ```bash
   ./build_docker.py docker/build_config.json        # –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è —Å–±–æ—Ä–∫–∞ —á–µ—Ä–µ–∑ buildx
   ./build_docker.py docker/build_config.json --dry-run  # —Ç–æ–ª—å–∫–æ –≤—ã–≤–µ—Å—Ç–∏ –∫–æ–º–∞–Ω–¥—ã
   ```

> ‚öôÔ∏è  –°–∫—Ä–∏–ø—Ç —Ç—Ä–µ–±—É–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π **docker buildx** (–≤—Ö–æ–¥–∏—Ç –≤ Docker CLI ‚â•20.10).

---
## 2. –§–æ—Ä–º–∞—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

| –ö–ª—é—á                | –¢–∏–ø          | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------------------|--------------|----------|
| `defaults.context`  | `string`     | –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–±–æ—Ä–∫–∏ (`.` –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) |
| `defaults.dockerfile` | `string`   | –ü—É—Ç—å –∫ Dockerfile (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `docker/Dockerfile-uv`) |
| **–û–ø–∏—Å–∞–Ω–∏–µ –æ–¥–Ω–æ–≥–æ build-–æ–±—ä–µ–∫—Ç–∞** | | |
| `tag`               | `string`     | –ò—Ç–æ–≥–æ–≤—ã–π —Ç–µ–≥ –æ–±—Ä–∞–∑–∞ (`myproject:dev-cu124`) |
| `mode`              | `string`     | –†–µ–∂–∏–º —Å–±–æ—Ä–∫–∏ (`dev` / `prod`) |
| `base_image`*       | `string`     | –ü–æ–ª–Ω—ã–π –±–∞–∑–æ–≤—ã–π –æ–±—Ä–∞–∑ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π) |
| `uv_version`        | `string`     | –í–µ—Ä—Å–∏—è uv, –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –∫–∞–∫ ARG `UV_VERSION` |
| `cmake_version`     | `string`     | –í–µ—Ä—Å–∏—è CMake, –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –∫–∞–∫ ARG `CMAKE_VERSION` |
| `toml_path`*        | `string`     | –ü—É—Ç—å –∫ `pyproject.toml` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π, ARG `TOML_PATH`) |
| `lock_path`*        | `string`     | –ü—É—Ç—å –∫ lock-—Ñ–∞–π–ª—É (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π, ARG `LOCK_PATH`) |
| `torch_index`*      | `string`     | URL —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è PyTorch wheels (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π, ARG `TORCH_INDEX`) |
| `platforms`         | `string`     | –ó–Ω–∞—á–µ–Ω–∏–µ `--platform` (–ø—Ä–∏–º–µ—Ä `linux/amd64,linux/arm64`) |
| `push`              | `bool`       | –î–æ–±–∞–≤–ª—è–µ—Ç `--push` –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ registry |
| `load`              | `bool`       | –î–æ–±–∞–≤–ª—è–µ—Ç `--load` –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π –¥–æ–∫–µ—Ä |
| `no_cache`          | `bool`       | –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —Å–±–æ—Ä–∫–∞ –±–µ–∑ –∫–µ—à–∞ |
| `cache_from`        | `string`     | `--cache-from` –∏—Å—Ç–æ—á–Ω–∏–∫ –∫–µ—à–∞ |
| `cache_to`          | `string`     | `--cache-to` –ø—Ä–∏—ë–º–Ω–∏–∫ –∫–µ—à–∞ |
| `dockerfile`        | `string`     | –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç `defaults.dockerfile` |
| `context`           | `string`     | –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç `defaults.context` |
| `args`              | `object`     | –ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ `--build-arg` (–æ–ø—Ü.) |

`builds` –º–æ–∂–µ—Ç –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º –∏–ª–∏ –æ–¥–Ω–∏–º –æ–±—ä–µ–∫—Ç–æ–º.  –ï—Å–ª–∏ —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç **–º–∞—Å—Å–∏–≤** –≤–µ—Ä—Ö–Ω–µ–≥–æ —É—Ä–æ–≤–Ω—è ‚Äî —Å—á–∏—Ç–∞–µ—Ç—Å—è —Å–ø–∏—Å–∫–æ–º —Å–±–æ—Ä–æ–∫, –∞ —Å–µ–∫—Ü–∏—è `defaults` –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è.

---
## 3. –ù–µ—Å–∫–æ–ª—å–∫–æ —Å–±–æ—Ä–æ–∫ –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ

```jsonc
[
  {
    "tag": "myproject:dev-cu124",
    "mode": "dev",
    "base_image": "nvidia/cuda:12.4.1-cudnn-devel-ubuntu22.04",
    "toml_path": "pyproject.toml",
    "lock_path": "py310_cu124.lock",
    "torch_index": "https://download.pytorch.org/whl/cu124",
  },
  {
    "tag": "myproject:prod-cu124",
    "mode": "prod",
    "base_image": "nvidia/cuda:12.4.1-cudnn-devel-ubuntu22.04",
    "toml_path": "prod/pyproject.toml",
    "lock_path": "prod/py310_cu124.lock",
    "torch_index": "https://download.pytorch.org/whl/cu124",
  }
]
```

–ó–∞–ø—É—Å–∫ –≤—ã–ø–æ–ª–Ω–∏—Ç –æ–±–µ —Å–±–æ—Ä–∫–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ.

---
## 4. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å CI/CD

–ü—Ä–∏–º–µ—Ä —à–∞–≥–∞ **GitHub Actions**:
```yaml
- name: Build & push Docker images
  run: |
    ./build_docker.py docker/build_config.json
```

–í Jenkins/GitLab CI –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ: —Å–∫—Ä–∏–ø—Ç —á–∏—Ç–∞–µ—Ç—Å—è –∫–∞–∫ –æ–±—ã—á–Ω—ã–π CLI.

---
## 5. –û—Ç–ª–∞–¥–∫–∞

1. –î–æ–±–∞–≤—å—Ç–µ —Ñ–ª–∞–≥ `--dry-run`, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ç–æ—á–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã `docker buildx`.
2. –ó–∞–¥–∞–π—Ç–µ `no_cache: true`, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å —Å–ª–æ–π.
3. –ß—Ç–æ–±—ã –≤–æ–π—Ç–∏ –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–ª–æ–π, —É–∫–∞–∂–∏—Ç–µ `--target deps-dev` –∏ –¥–æ–±–∞–≤—å—Ç–µ `load: true`, –∑–∞—Ç–µ–º:
   ```bash
   docker run -it <image_id> bash
   ```

---
## 6. –°–≤—è–∑—å —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π

–°–∫—Ä–∏–ø—Ç –¥–æ–ø–æ–ª–Ω—è–µ—Ç –≥–∞–π–¥ –∏–∑ ¬´[07_docker_deployment](07_docker_deployment.md)¬ª –∏ –Ω–µ –∑–∞–º–µ–Ω—è–µ—Ç `docker build` –Ω–∞–ø—Ä—è–º—É—é ‚Äî –æ–Ω –ª–∏—à—å –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–µ—Ç –ø–µ—Ä–µ–¥–∞—á—É –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –∏ —Ç–µ–≥–æ–≤.  –õ–æ–≥–∏–∫–∞ —Å–ª–æ—ë–≤ `Dockerfile-uv` –æ—Å—Ç–∞—ë—Ç—Å—è –Ω–µ–∏–∑–º–µ–Ω–Ω–æ–π.

---
## 7. –ß–µ–∫-–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º

- [ ] –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω Docker —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π **BuildKit/Buildx**.
- [ ] –§–∞–π–ª `docker/build_config.json` –≤–∞–ª–∏–¥–µ–Ω (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å `jq .`).
- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω –ª–æ–≥–∏–Ω –≤ –Ω—É–∂–Ω—ã–π Docker-registry, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `push`.
- [ ] –ï—Å—Ç—å –∫–µ—à-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π, –µ—Å–ª–∏ —É–∫–∞–∑—ã–≤–∞–µ—Ç–µ `cache_to` / `cache_from`.

> **‚ÑπÔ∏è –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ**. –ù–∞—á–∏–Ω–∞—è —Å Docker Engine 20.10, Buildx –∏ BuildKit –ø–æ—Å—Ç–∞–≤–ª—è—é—Ç—Å—è ¬´–∏–∑ –∫–æ—Ä–æ–±–∫–∏¬ª ‚Äî –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.
> –ö–æ–º–∞–Ω–¥–∞ `docker build` —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Buildx –ø–æ–¥ –∫–∞–ø–æ—Ç–æ–º, –Ω–æ –º—ã –≤—ã–∑—ã–≤–∞–µ–º `docker buildx build`, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ (`--platform`, `--load/--push`, –∫–µ—à-—Å–ª–æ–∏ –∏ —Ç. –¥.).  –°–º. –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—É—é —Å–ø—Ä–∞–≤–∫—É [docker buildx build](https://docs.docker.com/reference/cli/docker/buildx/build/) –∏ –æ–±–∑–æ—Ä [Docker Build Overview](https://docs.docker.com/build/concepts/overview/).

–¢–µ–ø–µ—Ä—å —Å–±–æ—Ä–∫–∞ Docker-–æ–±—Ä–∞–∑–æ–≤ –æ–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –æ–¥–Ω–æ–π JSON-—Å—Ç—Ä–æ–∫–æ–π! üéâ