# Документация по `docker/Dockerfile-uv`

## Общая идея

`Dockerfile-uv` — это **универсальный Docker-рецепт**, который позволяет собирать как *разработческое* (dev), так и *продакшен* (prod) окружения из одного файла. Он решает сразу несколько задач:

1. **Повторяемость окружения**: сборка выполняется строго по `uv.lock`, что гарантирует идентичные версии библиотек.
1. **Гибкость**: CUDA-версия, вариант базового образа (`runtime | cudnn | base`) и версия CMake передаются через `--build-arg`, поэтому образ можно быстро адаптировать под разные GPU-серверы.
1. **Минимизация лишнего веса**: продакшен-слой собирается без исходников проекта и без dev-зависимостей, а wheel-файл `flash-attn` переиспользуется.
1. **Единая точка поддержки**: вместо двух Dockerfile поддерживаем один, уменьшая трудозатраты.

## Для чего сделан

В проекте используется пакетный менеджер **`uv`** (аналог `pip-tools`/`poetry`) и необязательная зависимость **`flash-attn`**, которую зачастую нужно собирать из исходников под конкретную версию CUDA/torch. Задача Dockerfile:

- предоставить разработчикам готовую среду с установленными всеми пакетами, включая кастомный wheel `flash-attn`;
- дать продакшен-образ с минимальным набором зависимостей (без исходников, тестовых фреймворков и т. д.);
- избавить CI/CD от необходимости пересобирать `flash-attn` при каждой сборке: wheel компилируется один раз на промежуточном слое и кэшируется.

## Структура слоёв

| Слой | База | Назначение |
|------|------|------------|
| **0. `base`** | `nvidia/cuda:${CUDA_VERSION}-${CUDA_VARIANT}-devel-ubuntu${UBUNTU_VERSION}` | Устанавливаются системные зависимости (gcc, git, Python, …) и статический бинарь `uv`. |
| **2.a `deps-dev`** | `base` | `uv sync --locked` по корневому `uv.lock` + копия исходников проекта. |
| **2.b `deps-prod`** | `base` | Минимальное окружение по `prod/uv.lock`, без исходников. |
| **3 `wheel-dev`** | `deps-dev` | Сборка колеса `flash-attn` в dev-контексте. |
| **3.b `wheel-prod`** | `deps-prod` | Аналогичная сборка, но против minimal-env; wheel идентичен и может быть заимствован из кэша. |
| **4.a `dev`** | `deps-dev` + wheel | Финальный dev-образ: весь исходный код + готовый wheel. |
| **4.b `prod`** | `base` + wheel | Финальный prod-образ: только скомпилированные зависимости и wheel, без исходников. |

### Почему именно так

- **Раздельные слои `deps-*`**. Меняем `pyproject.toml` — пересчитываются лишь зависимости, а не заново всё.
- **Сборка wheel отдельным RUN**. Колесо `flash-attn` сильно зависит от CUDA: его кэшируется Docker и можно смонтировать в любой следующий слой.
- **`ENV UV_NO_BUILD_ISOLATION=1`**. Ускоряет сборку `flash-attn`, заставляя использовать уже установленный `torch` вместо повторной сборки в изоляции.
- **Переиспользование wheel в финальных слоях** снижает вес образа и экономит время на CI.
- **Кэш wheel-файла зависит от связки CUDA × PyTorch × Python.** Имя wheel-а содержит ABI-тег (`cp310`, `cp312`…), поэтому смена **любой** из трёх составляющих — версии CUDA, версии PyTorch или минорной версии Python — заставит Docker пересобрать слой. При неизменной тройке артефакт берётся из кэша практически мгновенно.

## Аргументы сборки

| ARG | Значение по умолчанию | Описание |
|-----|-----------------------|----------|
| `CUDA_VERSION` | `12.4.1` | Версия CUDA. При смене нужно убедиться, что существует соответствующий базовый образ NVIDIA. |
| `CUDA_VARIANT` | `cudnn` | Вариант базового образа (`runtime`, `cudnn`, `base`). |
| `UBUNTU_VERSION`| `22.04` | Версия Ubuntu в базе. |
| `CMAKE_VERSION` | `3.26.1` | Версия CMake для сборки `flash-attn`. |

<!-- остальной текст опущен для краткости; полная версия взята из исходного файла -->
